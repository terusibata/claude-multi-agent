# 06 - 本番運用

## スケーリング設計

### キャパシティプランニング

| パラメータ | 値 | 根拠 |
|-----------|-----|------|
| コンテナあたりリソース | 2 CPU / 4GB RAM | Agent SDK + Python 処理の実績値 |
| ホストあたりコンテナ数 | 8〜16 | ホストスペックに依存 |
| 推奨ホストスペック | 16 CPU / 64GB RAM | コンテナ×16 + オーバーヘッド |
| Warm Pool サイズ | 同時接続数の 10〜20% | コールドスタート回避 |

### スケーリング戦略

```
               ┌─ Auto Scaling Group ─────────────────┐
               │                                       │
  Scale Out    │  ┌──────┐ ┌──────┐ ┌──────┐          │  Scale In
  ──────────►  │  │Host 1│ │Host 2│ │Host 3│ ...      │  ◄──────────
  同時コンテナ  │  └──────┘ └──────┘ └──────┘          │  コンテナ利用率
  > 閾値       │                                       │  < 閾値
               └───────────────────────────────────────┘
```

| メトリクス | スケールアウト | スケールイン |
|-----------|--------------|------------|
| コンテナ利用率 | > 70% | < 30% |
| Warm Pool 枯渇 | プール空が3回連続 | - |
| ホスト CPU | > 80% | < 40% |
| ホストメモリ | > 75% | < 40% |

### コスト最適化

| 戦略 | 削減効果 | 実装難度 |
|------|---------|---------|
| Spot インスタンス (非本番ホスト) | 最大 60〜90% | 中 |
| 夜間・週末のスケールダウン | 30〜50% | 低 |
| コンテナリソースの適正化 (VPA 相当) | 20〜30% | 低 |
| ベースイメージの最適化（サイズ削減） | 間接的（起動時間短縮） | 低 |

## 障害復旧

### 障害パターンと対応

| 障害 | 検知方法 | 自動復旧 | 手動対応 |
|------|---------|---------|---------|
| コンテナクラッシュ | ヘルスチェック失敗 | 新コンテナ割り当て + S3 から復元 | 不要 |
| ホスト障害 | EC2 ステータスチェック | ASG が新ホスト起動 | 不要 |
| Docker デーモン停止 | systemd watchdog | systemd 自動再起動 | 再起動失敗時に確認 |
| S3 障害 | S3 エラーレスポンス | リトライ (exponential backoff) | AWS に問い合わせ |
| Redis 障害 | 接続エラー | Redis Sentinel/Cluster フェイルオーバー | 不要 |
| ネットワーク分断 | タイムアウト | リトライ + 別ホストへの再割り当て | 不要 |

### データ損失の最小化

```
コンテナクラッシュ時のデータ復旧フロー:

1. ヘルスチェック失敗を検知
2. 実行中リクエストに "container_lost" エラーを返却
3. Redis から会話のコンテナメタデータを取得
4. 新コンテナを割り当て
5. S3 から最新のワークスペースファイルを同期
6. ユーザーに「セッションが復旧された」旨を通知
   ※ 最後の同期以降の未保存変更は失われる可能性あり
```

### 定期同期による保護

- エージェント実行中、**ツール結果ごとに差分ファイルを S3 に同期**する
- これにより、コンテナクラッシュ時のデータ損失を最小限に抑える
- 同期は非同期で実行し、エージェントの実行を妨げない

## 監視設計

### メトリクス

#### インフラメトリクス

| メトリクス | 収集方法 | アラート閾値 |
|-----------|---------|------------|
| ホスト CPU 使用率 | cAdvisor / CloudWatch | > 85% |
| ホストメモリ使用率 | cAdvisor / CloudWatch | > 80% |
| ディスク使用率 | node_exporter | > 80% |
| コンテナ数 (アクティブ) | Docker API | > ホスト上限の 90% |
| Warm Pool サイズ | カスタムメトリクス | < 最小サイズ |

#### アプリケーションメトリクス

| メトリクス | 説明 | アラート閾値 |
|-----------|------|------------|
| コンテナ起動時間 | 割り当て〜Ready までの時間 | P95 > 10秒 |
| リクエスト成功率 | 200 / total | < 95% |
| コンテナクラッシュ率 | crash / total containers | > 5% |
| S3 同期エラー率 | error / total syncs | > 1% |
| TTL による破棄数 | 時間あたりの GC 数 | 急増時アラート |

### ログ戦略

```json
{
  "timestamp": "2026-02-07T10:30:00Z",
  "level": "INFO",
  "service": "workspace-orchestrator",
  "event": "container_created",
  "conversation_id": "conv-123",
  "tenant_id": "tenant-456",
  "container_id": "ws-abc",
  "source": "warm_pool",
  "duration_ms": 1200
}
```

### ダッシュボード構成

```
┌─ Workspace Isolation Dashboard ─────────────────────┐
│                                                       │
│  ┌─ コンテナ概要 ──┐  ┌─ リソース使用率 ──────────┐  │
│  │ Active:   24    │  │ [CPU グラフ]              │  │
│  │ Idle:     8     │  │ [メモリグラフ]             │  │
│  │ Pool:     3     │  │ [ディスクグラフ]            │  │
│  │ Total:    35    │  │                           │  │
│  └────────────────┘  └───────────────────────────┘  │
│                                                       │
│  ┌─ コンテナ起動時間 ─┐  ┌─ エラー率 ──────────────┐ │
│  │ [ヒストグラム]     │  │ [時系列グラフ]          │  │
│  │ P50: 1.2s         │  │ Container crash: 0.1%   │  │
│  │ P95: 4.5s         │  │ S3 sync error: 0.05%    │  │
│  │ P99: 8.2s         │  │ Health check fail: 0.2% │  │
│  └───────────────────┘  └─────────────────────────┘  │
└───────────────────────────────────────────────────────┘
```

## 実装ロードマップ

### Phase 1: 基本的なコンテナ隔離

- [ ] Workspace ベースイメージの作成
- [ ] ContainerOrchestrator の実装（Docker API 連携）
- [ ] Backend → Container 間の HTTP 通信
- [ ] S3 ファイル同期の実装
- [ ] TTL ベースの GC 実装
- [ ] 基本的なヘルスチェック

### Phase 2: 運用品質の向上

- [ ] Warm Pool の実装
- [ ] ネットワーク隔離（iptables ルール）
- [ ] リソース制限の適用（CPU、メモリ、PIDs、ディスク）
- [ ] 監視ダッシュボードの構築
- [ ] アラート設定

### Phase 3: セキュリティ強化

- [ ] seccomp プロファイルの適用
- [ ] AppArmor プロファイルの適用
- [ ] ネットワークホワイトリストの厳格化
- [ ] セキュリティ監査ログ

### Phase 4: スケーリング

- [ ] マルチホスト対応（コンテナスケジューリング）
- [ ] Auto Scaling の実装
- [ ] Spot インスタンス対応
- [ ] gVisor / Firecracker への移行検討
