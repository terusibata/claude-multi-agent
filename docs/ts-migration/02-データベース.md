# データベース設計

## 概要

本システムはPostgreSQL 15以上を使用し、SQLAlchemy 2.0の非同期機能でアクセスする。10個のテーブルで構成され、すべてのテーブルでマルチテナント分離を実現している。

---

## テーブル一覧

| テーブル名 | 説明 | 主キー |
|-----------|------|--------|
| tenants | テナント（組織）情報 | tenant_id（文字列） |
| models | AIモデル定義と料金設定 | model_id（文字列） |
| conversations | 会話セッション | conversation_id（UUID） |
| message_logs | メッセージ履歴 | message_id（UUID） |
| agent_skills | Agent Skillsメタデータ | skill_id（UUID） |
| mcp_servers | MCPサーバー設定 | mcp_server_id（UUID） |
| conversation_files | 会話内ファイル | file_id（UUID） |
| usage_logs | 使用状況ログ | usage_log_id（UUID） |
| tool_execution_logs | ツール実行ログ | tool_log_id（UUID） |

---

## テーブル詳細

### tenants（テナント）

マルチテナントの単位となるテーブル。各テナントは独自のシステムプロンプトとデフォルトモデルを持つ。

**フィールド構成**

- **tenant_id**：テナント識別子。外部システムから割り当てられる文字列（最大100文字）。主キー。
- **system_prompt**：AIの基本動作を定義するシステムプロンプト。テキスト型で制限なし。
- **model_id**：デフォルトで使用するモデルのID。modelsテーブルへの外部キー。
- **status**：テナントの状態。「active」または「inactive」。
- **created_at**：作成日時（タイムゾーン付き）。
- **updated_at**：更新日時（タイムゾーン付き）。

**リレーション**

- modelsテーブルと多対一（デフォルトモデル）
- conversationsテーブルと一対多
- agent_skillsテーブルと一対多
- mcp_serversテーブルと一対多
- usage_logsテーブルと一対多

### models（AIモデル定義）

AWS Bedrockで使用可能なClaudeモデルの定義。料金情報を含み、コスト計算に使用される。

**フィールド構成**

- **model_id**：内部管理用のモデル識別子（最大100文字）。主キー。
- **display_name**：UI表示用のモデル名（最大200文字）。
- **bedrock_model_id**：AWS Bedrockのモデル識別子（最大200文字）。例：「global.anthropic.claude-sonnet-4-5-20250929-v1:0」
- **model_region**：モデル実行リージョン（最大50文字）。未指定時はデフォルトリージョンを使用。
- **input_token_price**：入力トークンの単価（USD/1000トークン）。DECIMAL(10,6)。
- **output_token_price**：出力トークンの単価（USD/1000トークン）。DECIMAL(10,6)。
- **cache_creation_5m_price**：5分プロンプトキャッシュ作成の単価。DECIMAL(10,6)。
- **cache_creation_1h_price**：1時間プロンプトキャッシュ作成の単価。DECIMAL(10,6)。
- **cache_read_price**：キャッシュ読み込みの単価。DECIMAL(10,6)。
- **status**：モデルの状態。「active」または「deprecated」。
- **created_at**、**updated_at**：タイムスタンプ。

**コスト計算式**

総コスト = (入力トークン数 / 1000 × input_token_price) + (出力トークン数 / 1000 × output_token_price) + (5分キャッシュ作成トークン数 / 1000 × cache_creation_5m_price) + (1時間キャッシュ作成トークン数 / 1000 × cache_creation_1h_price) + (キャッシュ読み込みトークン数 / 1000 × cache_read_price)

### conversations（会話）

ユーザーとAIの会話セッションを管理する。SDKセッションIDを保持し、会話の継続を可能にする。

**フィールド構成**

- **conversation_id**：会話の一意識別子（UUID）。主キー。自動生成。
- **session_id**：Claude Agent SDKのセッションID（最大200文字）。会話を継続（resume）する際に使用。
- **tenant_id**：テナントID。tenantsテーブルへの外部キー。インデックス付き。
- **user_id**：ユーザー識別子（最大100文字）。インデックス付き。
- **model_id**：使用するモデルのID。modelsテーブルへの外部キー。
- **title**：会話タイトル（最大500文字）。初回実行後に自動生成。
- **status**：会話の状態。「active」または「archived」。インデックス付き。
- **workspace_enabled**：ワークスペース機能の有効/無効。ブール値。デフォルトはfalse。
- **workspace_path**：S3上のワークスペースパス（最大500文字）。
- **workspace_created_at**：ワークスペース作成日時。
- **created_at**、**updated_at**：タイムスタンプ。

**インデックス**

- tenant_id（テナント別の会話検索用）
- user_id（ユーザー別の会話検索用）
- status（アクティブ会話のフィルタ用）
- session_id（SDKセッション検索用）

**リレーション**

- tenantsテーブルと多対一
- modelsテーブルと多対一
- message_logsテーブルと一対多
- conversation_filesテーブルと一対多（CASCADE DELETE）
- usage_logsテーブルと一対多

### message_logs（メッセージログ）

エージェント実行中のすべてのメッセージを完全に記録する。デバッグと監査に使用。

**フィールド構成**

- **message_id**：メッセージの一意識別子（UUID）。主キー。
- **conversation_id**：会話ID。conversationsテーブルへの外部キー。インデックス付き。
- **message_seq**：会話内でのメッセージ順序番号（整数）。
- **message_type**：メッセージの種類（最大50文字）。「system」「assistant」「user_result」「result」「unknown」のいずれか。
- **message_subtype**：サブタイプ（最大50文字）。「init」「finish」「text」「text_delta」「tool_use」「thinking」など。
- **content**：メッセージ内容（JSONB）。任意のJSON構造。
- **timestamp**：メッセージ記録時刻。

**複合インデックス**

- (conversation_id, message_seq)：会話内のメッセージ順序取得用

**message_typeの説明**

- **system**：SDKの初期化（init）または終了（finish）メッセージ
- **assistant**：AIからの出力。テキスト（text）、ツール呼び出し（tool_use）、拡張思考（thinking）
- **user_result**：ツール実行結果
- **result**：実行完了メッセージ。使用量情報を含む

### agent_skills（Agent Skills）

テナント固有のカスタムスキルのメタデータを管理する。スキル本体はファイルシステム上のSKILL.mdに保存される。

**フィールド構成**

- **skill_id**：スキルの一意識別子（UUID）。主キー。
- **tenant_id**：テナントID（最大100文字）。インデックス付き。
- **name**：スキル名（最大200文字）。英数字・アンダースコア・ハイフンのみ許可。
- **display_title**：UI表示用タイトル（最大300文字）。
- **description**：スキルの説明（テキスト）。
- **version**：バージョン番号（整数）。更新時にインクリメント。
- **file_path**：SKILL.mdファイルの絶対パス（最大500文字）。
- **slash_command**：UIでのスラッシュコマンド（最大100文字）。例：「/review」
- **slash_command_description**：スラッシュコマンドの説明（最大500文字）。
- **is_user_selectable**：ユーザーがpreferred_skillsで指定可能かどうか。ブール値。
- **status**：スキルの状態。「active」または「inactive」。
- **created_at**、**updated_at**：タイムスタンプ。

**一意制約**

- (tenant_id, name)：テナント内でスキル名は一意

**ファイルシステム構造**

スキルファイルは以下のパスに配置される。
/skills/tenant_{tenant_id}/.claude/skills/{skill_name}/SKILL.md

### mcp_servers（MCPサーバー）

Model Context Protocol（MCP）サーバーの設定を管理する。5種類のサーバータイプをサポート。

**フィールド構成**

- **mcp_server_id**：MCPサーバーの一意識別子（UUID）。主キー。
- **tenant_id**：テナントID。インデックス付き。
- **name**：サーバー名（最大200文字）。テナント内で一意。
- **display_name**：UI表示名（最大300文字）。
- **type**：サーバータイプ（最大20文字）。「http」「sse」「stdio」「builtin」「openapi」のいずれか。
- **url**：HTTP/SSEサーバーのURL（最大500文字）。
- **command**：STDIOサーバーの実行コマンド（最大500文字）。
- **args**：コマンド引数（JSONB配列）。
- **env**：環境変数（JSONB オブジェクト）。
- **headers_template**：HTTPヘッダーテンプレート（JSONB）。トークン置換用のプレースホルダを含む。
- **allowed_tools**：許可するツール名リスト（JSONB配列）。
- **tools**：builtinタイプ用のツール定義（JSONB配列）。
- **description**：サーバーの説明（テキスト）。
- **openapi_spec**：OpenAPI仕様（JSONB）。openapiタイプ用。
- **openapi_base_url**：OpenAPI APIの基底URL（最大500文字）。
- **status**：サーバーの状態。「active」または「inactive」。
- **created_at**、**updated_at**：タイムスタンプ。

**一意制約**

- (tenant_id, name)：テナント内でサーバー名は一意

**サーバータイプの説明**

- **http**：HTTP経由でMCPプロトコルを使用
- **sse**：Server-Sent Events経由でMCPプロトコルを使用
- **stdio**：標準入出力を使用するローカルプロセス
- **builtin**：アプリケーション内蔵のツール
- **openapi**：OpenAPI仕様から自動生成されるツール

**headers_templateのトークン置換**

headers_templateには「${token_name}」形式のプレースホルダを記述できる。実行時にリクエストのtokensフィールドから対応する値に置換される。

例：「Authorization: Bearer ${servicenow}」

### conversation_files（会話ファイル）

会話に関連付けられたファイルを管理する。S3に実体を保存し、メタデータをデータベースで管理する。

**フィールド構成**

- **file_id**：ファイルの一意識別子（UUID）。主キー。
- **conversation_id**：会話ID（UUID）。conversationsテーブルへの外部キー。CASCADE DELETE。インデックス付き。
- **file_path**：ワークスペース内の相対パス（最大1000文字）。
- **original_name**：元のファイル名（最大500文字）。
- **file_size**：ファイルサイズ（BIGINT、バイト単位）。
- **mime_type**：MIMEタイプ（最大200文字）。
- **version**：バージョン番号（整数）。更新時にインクリメント。
- **source**：ファイルの出所（最大50文字）。「user_upload」「ai_created」「ai_modified」のいずれか。
- **is_presented**：AIがユーザーに提示したファイルかどうか。ブール値。
- **checksum**：SHA256チェックサム（64文字）。
- **description**：ファイルの説明（テキスト）。
- **status**：ファイルの状態。「active」または「deleted」。
- **created_at**、**updated_at**：タイムスタンプ。

**インデックス**

- conversation_id（会話別のファイル一覧取得用）
- source（ソース別のフィルタ用）

**sourceの説明**

- **user_upload**：ユーザーがアップロードしたファイル
- **ai_created**：AIが新規作成したファイル
- **ai_modified**：AIが既存ファイルを変更した結果

### usage_logs（使用状況ログ）

エージェント実行ごとのトークン使用量とコストを記録する。プロンプトキャッシング対応の5種類のトークンを追跡。

**フィールド構成**

- **usage_log_id**：ログの一意識別子（UUID）。主キー。
- **tenant_id**：テナントID。tenantsテーブルへの外部キー。インデックス付き。
- **user_id**：ユーザーID（最大100文字）。インデックス付き。
- **model_id**：使用モデルID。modelsテーブルへの外部キー。インデックス付き。
- **session_id**：SDKセッションID（最大200文字）。
- **conversation_id**：会話ID（UUID）。conversationsテーブルへの外部キー。インデックス付き。
- **input_tokens**：入力トークン数（整数）。
- **output_tokens**：出力トークン数（整数）。
- **cache_creation_5m_tokens**：5分キャッシュ作成トークン数（整数）。
- **cache_creation_1h_tokens**：1時間キャッシュ作成トークン数（整数）。
- **cache_read_tokens**：キャッシュ読み込みトークン数（整数）。
- **total_tokens**：合計トークン数（整数）。
- **cost_usd**：計算されたコスト（DECIMAL(10,6)、USD）。
- **executed_at**：実行日時（タイムゾーン付き）。インデックス付き。

**インデックス**

- tenant_id（テナント別の使用状況取得用）
- user_id（ユーザー別の使用状況取得用）
- model_id（モデル別の集計用）
- executed_at（期間別の集計用）
- conversation_id（会話別の使用状況取得用）

**サブエージェントの追跡**

サブエージェント（Taskツール）が使用したトークンは、サブエージェント用のモデルID（通常はHaiku）で別レコードとして記録される。これにより、メインエージェントとサブエージェントの使用量を区別して集計できる。

### tool_execution_logs（ツール実行ログ）

エージェントが実行したすべてのツールを記録する。デバッグと監査に使用。

**フィールド構成**

- **tool_log_id**：ログの一意識別子（UUID）。主キー。
- **session_id**：SDKセッションID（最大200文字）。インデックス付き。
- **conversation_id**：会話ID（UUID）。インデックス付き。
- **tool_name**：ツール名（最大200文字）。インデックス付き。例：「Read」「Write」「mcp__servicenow__create_incident」
- **tool_use_id**：SDKから渡されるツール使用ID（最大200文字）。
- **tool_input**：ツールへの入力パラメータ（JSONB）。
- **tool_output**：ツールの出力結果（JSONB）。
- **status**：実行結果の状態。「success」または「error」。
- **execution_time_ms**：実行時間（整数、ミリ秒）。
- **executed_at**：実行日時。インデックス付き。

**インデックス**

- session_id（セッション別のツール実行履歴取得用）
- conversation_id（会話別のツール実行履歴取得用）
- tool_name（ツール別の統計用）
- executed_at（期間別の集計用）

---

## リレーション図

主要なテーブル間のリレーションを以下に示す。

**テナントを中心としたリレーション**

tenants → conversations（一対多）：テナントは複数の会話を持つ
tenants → agent_skills（一対多）：テナントは複数のスキルを持つ
tenants → mcp_servers（一対多）：テナントは複数のMCPサーバーを持つ
tenants → usage_logs（一対多）：テナントは複数の使用ログを持つ

**モデルを中心としたリレーション**

models → tenants（一対多）：モデルは複数のテナントのデフォルトになりうる
models → conversations（一対多）：モデルは複数の会話で使用される
models → usage_logs（一対多）：モデルは複数の使用ログに関連付けられる

**会話を中心としたリレーション**

conversations → message_logs（一対多）：会話は複数のメッセージログを持つ
conversations → conversation_files（一対多、CASCADE DELETE）：会話は複数のファイルを持つ
conversations → usage_logs（一対多）：会話は複数の使用ログを持つ

---

## インデックス戦略

パフォーマンスを確保するため、以下のインデックス戦略を採用している。

**テナント分離用インデックス**

すべてのテナント関連テーブルにtenant_idのインデックスを作成し、テナント単位のクエリを高速化する。

**時系列クエリ用インデックス**

usage_logsとtool_execution_logsのexecuted_atにインデックスを作成し、期間指定のクエリを高速化する。

**セッション検索用インデックス**

conversationsとtool_execution_logsのsession_idにインデックスを作成し、SDKセッションの検索を高速化する。

**複合インデックス**

message_logsの(conversation_id, message_seq)に複合インデックスを作成し、会話内のメッセージ順序取得を高速化する。
