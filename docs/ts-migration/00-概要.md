# プロジェクト概要

## 基本情報

本システムは「Claude Multi-Agent Backend」という名称のマルチテナント対応AIエージェント実行基盤である。

### システムの目的

企業向けに、Claude AIエージェントを安全かつ効率的に運用するためのバックエンドサービスを提供する。各テナント（組織）は独自のシステムプロンプト、カスタムスキル、外部API連携を設定でき、ユーザーはAIとの会話を通じて複雑なタスクを実行できる。

### 技術基盤

- 言語：Python 3.11以上
- Webフレームワーク：FastAPI
- データベース：PostgreSQL（SQLAlchemy 2.0 + asyncpg）
- AI基盤：AWS Bedrock上のClaudeモデル
- AIエージェントSDK：Claude Agent SDK
- ストレージ：Amazon S3（ワークスペース用）

### 主要機能

1. **マルチテナント管理**
   - テナント単位でのシステムプロンプト設定
   - テナント単位でのデフォルトモデル設定
   - テナント単位でのリソース分離

2. **会話管理**
   - 会話の作成・更新・アーカイブ
   - SDKセッションとの連携（会話の継続実行）
   - メッセージログの完全記録

3. **エージェント実行**
   - Server-Sent Events（SSE）によるストリーミング応答
   - 複数ツールの並列実行対応
   - サブエージェント（Taskツール）の追跡

4. **Agent Skills**
   - ファイルベースのカスタムスキル管理
   - スラッシュコマンドによるUI連携
   - スキルの優先指定機能

5. **MCPサーバー統合**
   - HTTP/SSE/STDIO/Builtin/OpenAPI形式のサポート
   - 動的なトークン置換によるAPI認証
   - OpenAPI仕様からの自動ツール生成

6. **ワークスペース**
   - 会話ごとの独立したファイル空間
   - S3とローカルキャッシュの二層構造
   - ファイルのバージョン管理とソース追跡

7. **使用状況追跡**
   - トークン使用量の詳細記録
   - プロンプトキャッシング対応のコスト計算
   - モデル別・期間別のレポート生成

---

## ディレクトリ構成

プロジェクトは以下のディレクトリ構成を持つ。

### アプリケーションコード（app/）

- **api/**：APIエンドポイント定義（7つのルーターモジュール）
- **models/**：SQLAlchemy ORMモデル定義（10個のテーブル）
- **schemas/**：Pydanticリクエスト・レスポンススキーマ
- **services/**：ビジネスロジック層（10個のサービス）
- **services/execute/**：エージェント実行専用サブモジュール
- **utils/**：共通ユーティリティ関数

### その他

- **tests/**：pytestによるテストコード
- **alembic/**：データベースマイグレーション
- **docs/**：APIドキュメント・仕様書
- **init-db/**：データベース初期化スクリプト

---

## 依存パッケージ

### コア依存

- **fastapi**：非同期対応Webフレームワーク
- **uvicorn**：ASGIサーバー
- **sqlalchemy**：ORM（2.0系の非同期対応版）
- **asyncpg**：PostgreSQL非同期ドライバー
- **pydantic**：データ検証・シリアライゼーション
- **pydantic-settings**：環境変数からの設定管理

### AI/AWS関連

- **claude-agent-sdk**：Claudeエージェント実行SDK
- **boto3**：AWS SDK（S3、Bedrock連携）

### ストリーミング

- **sse-starlette**：Server-Sent Eventsサポート

### ユーティリティ

- **python-dotenv**：.envファイル読み込み
- **PyYAML**：YAML処理
- **structlog**：構造化ログ出力

---

## 動作環境

### 必須要件

- Python 3.11以上
- PostgreSQL 15以上
- AWS認証情報（Bedrock、S3アクセス用）
- Node.js（Claude Agent SDKの内部依存）

### 推奨構成

本番環境では、Dockerコンテナとして実行することを推奨する。docker-compose.ymlにより、PostgreSQLデータベースとバックエンドアプリケーションを一括で起動できる。

---

## 設計原則

本システムは以下の設計原則に基づいて構築されている。

1. **レイヤードアーキテクチャ**
   - API層、サービス層、データアクセス層の明確な分離
   - 各層の責務を限定し、テスタビリティを確保

2. **非同期ファースト**
   - すべてのI/O処理は非同期で実行
   - データベース接続プールによる効率的なリソース利用

3. **マルチテナント分離**
   - アプリケーションレベルでのデータ分離
   - すべてのテーブルにtenant_idを含める設計

4. **ストリーミング優先**
   - AIレスポンスはSSEでリアルタイム配信
   - 長時間実行タスクでもレスポンシブなUXを実現

5. **拡張性**
   - MCPサーバーによる外部システム連携の容易化
   - Agent Skillsによるカスタム機能の追加
