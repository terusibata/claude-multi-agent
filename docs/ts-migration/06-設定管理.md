# 設定管理

## 概要

本システムは環境変数を使用した設定管理を採用している。pydantic-settingsのBaseSettingsクラスにより、環境変数を型安全に読み込む。設定インスタンスはlru_cacheでキャッシュされ、アプリケーション全体で単一インスタンスとして共有される。

---

## 環境変数一覧

### データベース設定

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| DATABASE_URL | はい | なし | PostgreSQL接続URL（asyncpg形式） |

DATABASE_URLの形式は「postgresql+asyncpg://user:password@host:port/database」となる。

### AWS Bedrock設定

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| CLAUDE_CODE_USE_BEDROCK | いいえ | 1 | Bedrockを使用するフラグ（1で有効） |
| AWS_REGION | いいえ | us-west-2 | デフォルトのAWSリージョン |
| AWS_ACCESS_KEY_ID | いいえ | なし | AWSアクセスキーID |
| AWS_SECRET_ACCESS_KEY | いいえ | なし | AWSシークレットアクセスキー |
| AWS_SESSION_TOKEN | いいえ | なし | AWSセッショントークン（一時認証用） |

本番環境ではIAMロールを使用することを推奨する。IAMロール使用時は認証情報の環境変数は不要。

### モデル設定

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| ANTHROPIC_SONNET_MODEL | いいえ | global.anthropic.claude-sonnet-4-5-20250929-v1:0 | メインエージェント用Sonnetモデル |
| ANTHROPIC_HAIKU_MODEL | いいえ | global.anthropic.claude-haiku-4-5-20251001-v1:0 | サブエージェント用Haikuモデル |
| CLAUDE_CODE_SUBAGENT_MODEL | いいえ | haiku | サブエージェントのデフォルトモデル（エイリアス） |

モデルIDの「global.」プレフィックスはクロスリージョン推論を示す。これにより、リージョン固有のモデルに比べて可用性が向上する。

### アプリケーション設定

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| APP_ENV | いいえ | development | 環境識別子（development/production） |
| APP_PORT | いいえ | 8000 | アプリケーションのリッスンポート |
| LOG_LEVEL | いいえ | INFO | ログ出力レベル（DEBUG/INFO/WARN/ERROR） |
| SKILLS_BASE_PATH | いいえ | /skills | Agent Skillsファイルの基底パス |

### S3ワークスペース設定

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| S3_BUCKET_NAME | はい | なし | ワークスペース用S3バケット名 |
| S3_WORKSPACE_PREFIX | いいえ | workspaces/ | S3内のプレフィックス |
| WORKSPACE_TEMP_DIR | いいえ | /var/lib/aiagent/workspaces | ローカルキャッシュディレクトリ |
| MAX_UPLOAD_FILE_SIZE | いいえ | 104857600 | 最大アップロードサイズ（バイト、デフォルト100MB） |

### セキュリティ設定

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| CORS_ORIGINS | いいえ | http://localhost:3000,http://localhost:3001 | 許可するCORSオリジン（カンマ区切り） |
| RATE_LIMIT_REQUESTS | いいえ | 100 | レート制限のリクエスト数 |
| RATE_LIMIT_PERIOD | いいえ | 60 | レート制限の期間（秒） |

---

## 設定クラス

### Settingsクラスの構成

Settingsクラスはpydantic_settings.BaseSettingsを継承し、環境変数からの自動読み込みをサポートする。各フィールドは適切な型アノテーションとデフォルト値を持つ。

### 計算プロパティ

Settingsクラスは以下の計算プロパティを提供する。

- **cors_origins_list**：CORS_ORIGINSをカンマで分割したリストを返す
- **is_production**：APP_ENVが「production」かどうかを返す
- **is_development**：APP_ENVが「development」かどうかを返す

### 設定のキャッシュ

get_settings()関数はlru_cacheデコレータでキャッシュされる。これにより、設定インスタンスは初回呼び出し時に一度だけ生成され、以降は同じインスタンスが返される。

---

## 環境別の設定

### 開発環境

開発環境では以下の設定が推奨される。

- APP_ENV=development
- LOG_LEVEL=DEBUG（SQLクエリログを含む詳細ログ）
- CORS_ORIGINS=http://localhost:3000,http://localhost:3001
- AWS認証情報は環境変数またはAWS CLIのプロファイルから取得

### 本番環境

本番環境では以下の設定が推奨される。

- APP_ENV=production
- LOG_LEVEL=INFO
- CORS_ORIGINS=具体的なドメインのみ
- AWS認証情報はIAMロールから取得（環境変数不要）
- DATABASE_URLにはSSL接続パラメータを含める

---

## データベース接続設定

### 接続プール

SQLAlchemyの非同期エンジンは以下の接続プール設定を使用する。

- **pool_size**：10（常時保持する接続数）
- **max_overflow**：20（追加で許可する接続数）
- **pool_pre_ping**：True（使用前に接続の有効性をチェック）

### SQLエコー

開発環境かつLOG_LEVELがDEBUGの場合のみ、SQLクエリをログ出力する。本番環境ではパフォーマンスのため無効化される。

---

## AWS設定の優先順位

AWS認証情報は以下の優先順位で解決される。

1. 環境変数（AWS_ACCESS_KEY_ID等）
2. IAMロール（EC2/ECS/Lambda等で自動取得）
3. AWS CLIのプロファイル

モデル実行リージョンは以下の優先順位で決定される。

1. Modelエンティティのmodel_region
2. 環境変数AWS_REGION
3. デフォルト値（us-west-2）

---

## ログ設定

### 構造化ログ

structlogライブラリを使用して構造化ログを出力する。JSON形式でログを出力し、ログ収集システムとの連携を容易にする。

### ログレベル

LOG_LEVEL環境変数で以下のレベルを設定可能。

- **DEBUG**：詳細なデバッグ情報（SQLクエリ含む）
- **INFO**：通常の動作情報
- **WARN**：警告
- **ERROR**：エラー

### 機密情報のサニタイズ

ログ出力前に機密情報をサニタイズする。対象フィールドはaws_access_key_id、aws_secret_access_key、aws_session_token、authorization、password、token、api_key、secretなど。これらは「[REDACTED]」に置換される。

---

## 設定ファイル

### .env.example

リポジトリには.env.exampleファイルが含まれる。開発者はこれをコピーして.envファイルを作成し、環境に合わせて値を設定する。

### Docker環境

docker-compose.ymlではenv_fileディレクティブで.envファイルを読み込む。本番環境ではDockerの環境変数機能やシークレット管理サービスを使用することを推奨する。

### 環境変数の検証

アプリケーション起動時に必須の環境変数が設定されているか検証する。DATABASE_URLとS3_BUCKET_NAMEは必須であり、未設定の場合は起動エラーとなる。
