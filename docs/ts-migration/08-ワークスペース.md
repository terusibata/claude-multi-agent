# ワークスペース設計

## 概要

ワークスペースは会話ごとに独立したファイル空間を提供する機能である。ユーザーがアップロードしたファイルやAIが生成したファイルを管理し、AIエージェントのファイル操作をサポートする。S3を永続ストレージとし、ローカルキャッシュとの二層構造で運用される。

---

## アーキテクチャ

### 二層構造

ワークスペースはS3とローカルファイルシステムの二層構造で管理される。

**S3層（永続ストレージ）**

ファイルの実体を永続的に保存する。会話が終了した後もファイルは保持される。バケット内のプレフィックス「workspaces/{conversation_id}/」配下に保存される。

**ローカル層（キャッシュ）**

SDK実行時にS3からローカルにファイルを同期する。SDKのファイル操作ツール（Read、Write等）はローカルファイルシステムに対して動作する。設定のWORKSPACE_TEMP_DIR配下に会話IDごとのディレクトリを作成。

### 同期フロー

1. エージェント実行開始前にS3からローカルにファイルを同期
2. SDKがローカルファイルシステムに対してファイル操作を実行
3. 操作されたファイルをS3に反映（必要に応じて）
4. ファイルメタデータをデータベースに記録

---

## データモデル

### conversation_filesテーブル

ワークスペース内のファイルメタデータを管理するテーブル。

**主要フィールド**

- file_id：ファイルの一意識別子（UUID）
- conversation_id：所属する会話のID
- file_path：ワークスペース内の相対パス
- original_name：元のファイル名
- file_size：ファイルサイズ（バイト）
- mime_type：MIMEタイプ
- version：バージョン番号（更新時にインクリメント）
- source：ファイルの出所（user_upload/ai_created/ai_modified）
- is_presented：AIがユーザーに提示したファイルかどうか
- checksum：SHA256チェックサム
- status：ファイルの状態（active/deleted）

### sourceフィールドの意味

- **user_upload**：ユーザーがアップロードしたファイル
- **ai_created**：AIが新規作成したファイル
- **ai_modified**：AIが既存ファイルを変更した結果

### is_presentedフラグ

AIが実行結果としてユーザーに提示したいファイルにtrueを設定。クライアントはこのフラグを使用して、ダウンロードリンクを表示するなどの処理を行える。

---

## API操作

### ワークスペース情報取得

GET /api/tenants/{tenant_id}/workspace/{conversation_id}

会話のワークスペース情報を取得する。workspace_enabled、workspace_path、file_count、total_size、ファイル一覧を含む。

### ファイルアップロード

POST /api/tenants/{tenant_id}/workspace/{conversation_id}/files

multipart/form-dataでファイルをアップロードする。fileフィールドにファイル、pathフィールドに保存先パス（オプション）、descriptionフィールドにファイル説明（オプション）を指定。

**処理フロー**

1. ファイルサイズチェック（MAX_UPLOAD_FILE_SIZE以下）
2. パストラバーサルチェック
3. SHA256チェックサム計算
4. S3にアップロード
5. ローカルキャッシュに保存
6. MIMEタイプ推定
7. データベースにメタデータ保存

### ファイルダウンロード

GET /api/tenants/{tenant_id}/workspace/{conversation_id}/files/{file_id}

ファイルをダウンロードする。S3から直接取得してバイナリデータを返す。Content-Typeにはファイルのmime_typeを設定。

### ファイル削除

DELETE /api/tenants/{tenant_id}/workspace/{conversation_id}/files/{file_id}

ファイルを削除する。S3からの物理削除とローカルキャッシュからの削除を行い、データベースでは論理削除（statusをdeletedに変更）。

---

## AIへのコンテキスト提供

### WorkspaceContextForAI

エージェント実行時、AIにワークスペース情報を提供する。この情報はシステムプロンプトに追加される。

**提供情報**

- workspace_path：ローカルワークスペースの絶対パス
- files：ファイル一覧（パス、元ファイル名、サイズ、ソース、提示フラグ）
- instructions：ファイル操作のガイドライン

**instructionsの内容**

AIに対して、ワークスペースパスを基準としてファイル操作を行うよう指示する。Readツール、Writeツールの使用方法と、作成したファイルが自動追跡されることを説明。

---

## S3構造

### パス規則

S3内のファイルは以下のパス構造で保存される。

{bucket_name}/{s3_workspace_prefix}{conversation_id}/{file_path}

例：
- バケット：aiagent-workspace-prod
- プレフィックス：workspaces/
- 会話ID：550e8400-e29b-41d4-a716-446655440000
- ファイルパス：documents/report.pdf

結果：aiagent-workspace-prod/workspaces/550e8400-e29b-41d4-a716-446655440000/documents/report.pdf

### ライフサイクル

ファイルは会話に紐づいて管理される。会話がアーカイブされてもファイルは保持される。必要に応じてS3のライフサイクルポリシーでアーカイブ会話のファイルを自動削除することも可能。

---

## ローカルキャッシュ

### ディレクトリ構造

ローカルキャッシュは以下の構造で管理される。

{WORKSPACE_TEMP_DIR}/{conversation_id}/{file_path}

例：
- WORKSPACE_TEMP_DIR：/var/lib/aiagent/workspaces
- 会話ID：550e8400-e29b-41d4-a716-446655440000
- ファイルパス：documents/report.pdf

結果：/var/lib/aiagent/workspaces/550e8400-e29b-41d4-a716-446655440000/documents/report.pdf

### 同期タイミング

エージェント実行開始前にsync_to_localメソッドが呼ばれ、S3からローカルにファイルを同期する。この処理により、SDKのファイル操作ツールが正しく動作する。

### クリーンアップ

ローカルキャッシュは一時的なものであり、サーバー再起動時やディスク容量の都合で削除される可能性がある。常にS3が正本となる。

---

## セキュリティ

### ファイルサイズ制限

MAX_UPLOAD_FILE_SIZE環境変数で最大アップロードサイズを制限する。デフォルトは100MB（104857600バイト）。この制限を超えるファイルはFileSizeErrorでリジェクトされる。

### パストラバーサル防止

ファイルパスに「..」が含まれる場合、PathTraversalErrorでリジェクトする。また、パスを正規化した後、ベースパスの外に出ていないことを検証する。

### チェックサム検証

アップロード時にSHA256チェックサムを計算して保存する。必要に応じてダウンロード時の整合性チェックに使用できる。

### 会話単位の分離

各会話のワークスペースは完全に分離されている。他の会話のファイルにアクセスすることはできない。

---

## 会話との連携

### workspace_enabledフラグ

会話作成時にworkspace_enabledフラグを設定する。デフォルトはtrue。falseの場合、ワークスペース機能は無効となり、AIのファイル操作は制限される。

### workspace_path

会話のworkspace_pathフィールドに、S3上のワークスペースパスが保存される。初回ファイルアップロードまたはワークスペース作成時に設定。

### workspace_created_at

ワークスペースが作成された日時を記録。最初のファイル操作時に設定される。
