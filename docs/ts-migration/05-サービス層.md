# サービス層設計

## 概要

サービス層はビジネスロジックを実装する中核層である。各サービスは単一責任の原則に従い、特定のドメインを担当する。サービスはデータベースセッションを受け取り、トランザクション管理を行う。

---

## サービス一覧

| サービス | 責務 | ファイルサイズ |
|---------|------|---------------|
| ExecuteService | エージェント実行のコア機能 | 約37KB |
| OpenApiMcpService | OpenAPI仕様からMCPツールへの変換 | 約28KB |
| WorkspaceService | S3ワークスペース管理 | 約22KB |
| SkillService | Agent Skills管理 | 約17KB |
| McpServerService | MCPサーバー設定管理 | 約13KB |
| UsageService | 使用状況記録と集計 | 約12KB |
| ConversationService | 会話のCRUD | 約10KB |
| BuiltinToolsService | 組み込みツール定義 | 約10KB |
| ModelService | モデル定義とコスト計算 | 約5KB |
| TenantService | テナントのCRUD | 約3KB |

---

## ExecuteService

エージェント実行のコア機能を担う最も重要なサービス。

### 主要メソッド

**execute_streaming**

エージェント実行のメインメソッド。AsyncGeneratorとしてSSEイベントを逐次返す。リクエスト、テナント、モデルを受け取り、会話ロックの取得からSDK実行、後処理までを一貫して行う。

### 依存サービス

- ConversationService：会話の取得・更新
- UsageService：使用量の記録
- SkillService：アクティブスキルの取得
- McpServerService：MCPサーバー設定の取得
- WorkspaceService：ワークスペース情報の取得
- OptionsBuilder：SDKオプションの構築

### 内部コンポーネント

ExecuteServiceは以下のサブコンポーネントを使用する。

- **ExecutionContext**：実行に必要な情報を集約したデータクラス
- **OptionsBuilder**：SDKオプションを構築するビルダー
- **ToolTracker**：ツール実行を追跡するトラッカー
- **MessageProcessor**：SDKメッセージをSSEイベントに変換するプロセッサ

---

## execute/サブモジュール

ExecuteServiceを支援する専用サブモジュール群。

### context.py

ExecutionContextデータクラスを定義。実行リクエスト、テナント、モデル、会話ID、セッションID、ターン番号、ワークスペース設定、優先スキル、開始時刻、作業ディレクトリ、結果テキスト、エラー配列、メッセージログ配列を保持する。

### aws_config.py

AWS Bedrock設定を管理するAWSConfigクラスを定義。モデルごとのリージョン設定をサポートし、SDK実行用の環境変数を構築する。

### model_mapping.py

サブエージェントモデルのエイリアス解決を行うSubagentModelMappingクラスを定義。「haiku」「sonnet」などのエイリアスを環境変数から実際のBedrockモデルIDに変換する。

### options_builder.py

SDKオプションを構築するOptionsBuilderクラスを定義。システムプロンプトの組み立て、MCPサーバー設定の構築、AWS環境変数の設定、作業ディレクトリの決定を行う。

### tool_tracker.py

ツール実行を追跡するToolTrackerクラスを定義。ToolExecutionInfo（ツール実行情報）とSubagentUsageInfo（サブエージェント使用量情報）を管理し、並列実行されるサブエージェントも正確に追跡する。

### message_processor.py

SDKメッセージをSSEイベントに変換するMessageProcessorクラスを定義。メッセージタイプ（system、assistant、user、result）に応じた処理を行い、ToolTrackerと連携してツール実行状態を更新する。

---

## ConversationService

会話のCRUD操作を担当。

### 主要メソッド

- **find_by_id**：会話IDで会話を取得。テナント、モデル、ファイルをeager loadする。
- **find_by_tenant**：テナントIDで会話一覧を取得。user_id、statusでフィルタ可能。ページネーション対応。
- **create**：新規会話を作成。model_id未指定時はテナントのデフォルトモデルを使用。
- **update**：会話を更新。title、model_id、statusを更新可能。
- **update_session_id**：session_idのみを更新。SDK実行後に呼び出される。
- **archive**：会話をアーカイブ（statusをarchivedに変更）。
- **get_messages**：会話のメッセージログを取得。message_seq順でソート。ページネーション対応。

---

## TenantService

テナントのCRUD操作を担当。

### 主要メソッド

- **find_all**：全テナント一覧を取得。モデルをeager load。
- **find_by_id**：テナントIDでテナントを取得。
- **create**：新規テナントを作成。model_id指定時はモデル存在確認を行う。
- **update**：テナントを更新。system_prompt、model_id、statusを更新可能。
- **delete**：テナントを削除。

---

## ModelService

モデル定義の管理とコスト計算を担当。

### 主要メソッド

- **find_all**：全モデル一覧を取得。statusでフィルタ可能。
- **find_by_id**：モデルIDでモデルを取得。
- **create**：新規モデルを作成。料金情報を含む。
- **update**：モデルを更新。
- **delete**：モデルを削除。

### コスト計算

Modelエンティティ自体にcalculate_costメソッドを実装。入力トークン、出力トークン、キャッシュ関連トークンを受け取り、各単価を適用してDecimalで総コストを返す。

---

## SkillService

Agent Skillsの管理を担当。データベースとファイルシステムの両方を操作する。

### 主要メソッド

- **find_all_by_tenant**：テナントの全スキル一覧を取得。
- **find_by_id**：スキルIDでスキルを取得。
- **find_active_by_tenant**：テナントのアクティブスキル一覧を取得。
- **create**：新規スキルを作成。SKILL.mdファイルを作成し、メタデータをDBに保存。
- **update**：スキルを更新。ファイル内容とメタデータの両方を更新可能。バージョンをインクリメント。
- **delete**：スキルを削除。ファイルとDBレコードの両方を削除。
- **get_slash_commands**：ユーザー選択可能でslash_commandが設定されているスキルの一覧を取得。UI用。
- **get_skill_content**：スキルのSKILL.mdファイル内容を取得。

### ファイルパス管理

スキルファイルは「/skills/tenant_{tenant_id}/.claude/skills/{skill_name}/SKILL.md」に配置される。パストラバーサル防止のため、ファイル操作前にパスの正規化と検証を行う。

---

## McpServerService

MCPサーバー設定の管理を担当。

### 主要メソッド

- **find_all_by_tenant**：テナントの全MCPサーバー一覧を取得。
- **find_by_id**：サーバーIDでMCPサーバーを取得。
- **find_active_by_tenant**：テナントのアクティブMCPサーバー一覧を取得。
- **create**：新規MCPサーバーを作成。タイプに応じたバリデーションを実施。
- **update**：MCPサーバーを更新。
- **delete**：MCPサーバーを削除。

### SDK設定構築

**build_sdk_config**メソッドで、McpServerエンティティの配列からSDK形式のMCPサーバー設定を構築する。タイプに応じて以下の変換を行う。

- **http/sse**：urlとheaders（トークン置換後）を設定
- **stdio**：command、args、envを設定
- **builtin**：toolsをそのまま設定
- **openapi**：OpenApiMcpServiceに委譲

### トークン置換

headers_templateの「${token_name}」形式のプレースホルダを、リクエストのtokensマップから対応する値に置換する。マッチしない場合は空文字列に置換される。

---

## UsageService

使用状況の記録と集計を担当。

### 主要メソッド

- **create**：使用ログを作成。
- **find_by_tenant**：テナントの使用ログ一覧を取得。user_id、model_id、期間でフィルタ可能。ページネーション対応。
- **get_summary**：期間・集計単位別のサマリーを取得。PostgreSQLのDATE_TRUNC関数を使用。
- **get_cost_report**：モデル別のコストレポートを取得。

### サマリー集計

日次（day）、週次（week）、月次（month）の集計をサポート。各期間のtotal_tokens、input_tokens、output_tokens、キャッシュトークン、total_cost_usd、execution_countを集計する。

---

## WorkspaceService

S3ワークスペースの管理を担当。

### 主要メソッド

- **get_workspace_info**：会話のワークスペース情報を取得。
- **get_workspace_context**：AIに提供するワークスペースコンテキスト（パス、ファイル一覧、操作指示）を取得。
- **upload_file**：ファイルをアップロード。S3とローカルキャッシュの両方に保存。
- **download_file**：ファイルをダウンロード。S3から取得。
- **delete_file**：ファイルを削除。S3とローカルキャッシュから削除し、DBを論理削除。
- **sync_to_local**：S3からローカルキャッシュに同期。SDK実行前に呼び出される。
- **get_local_path**：会話のローカルワークスペースパスを取得。

### 二層構造

ファイルはS3に永続保存され、SDK実行時にローカルキャッシュに同期される。これによりステートレスなアプリケーションサーバーを維持しつつ、SDKのファイル操作をサポートする。

### セキュリティ

ファイルサイズは設定の最大値（デフォルト100MB）でチェック。パスにはパストラバーサル防止のバリデーションを適用。チェックサム（SHA256）を計算して保存。

---

## OpenApiMcpService

OpenAPI仕様からMCPツールへの変換を担当。最も複雑なサービスの一つ。

### 主要機能

- OpenAPI 3.0/3.1仕様の解析
- パス・メソッドからMCPツール名の生成
- パラメータ・リクエストボディからJSON Schemaの生成
- 認証設定の変換

### 変換ルール

OpenAPIのoperationIdまたはパス+メソッドからツール名を生成。パラメータとリクエストボディを統合したinput_schemaを生成。descriptionはsummaryとdescriptionから構築。

---

## BuiltinToolsService

組み込みツールの定義を担当。builtinタイプのMCPサーバーで使用されるツールを提供する。

### 提供ツール例

計算、現在時刻取得などの基本的なユーティリティツール。これらはサーバーサイドで直接実行され、外部サービスへのアクセスは行わない。
