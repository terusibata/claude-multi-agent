# エージェント実行設計

## 概要

本システムの中核機能であるエージェント実行について説明する。Claude Agent SDKを使用し、ユーザー入力に対してAIが適切なツールを選択・実行しながら応答を生成する。

---

## 実行フローの全体像

エージェント実行は以下の10ステップで構成される。

### ステップ1：リクエスト受信

クライアントからPOSTリクエストを受信する。リクエストにはユーザー入力（user_input）、実行者情報（executor）、MCPトークン（tokens、オプション）、優先スキル（preferred_skills、オプション）が含まれる。

### ステップ2：事前検証

テナント、会話、モデルの存在と状態を検証する。テナントまたはモデルが「inactive」状態の場合はエラーを返す。会話が存在しない場合もエラーを返す。

### ステップ3：会話ロック取得

同一会話への同時アクセスを防ぐため、会話ロックを取得する。ロックは最大600秒で自動解放される。ロック取得の待機タイムアウトは5秒。既にロックされている場合はConversationLockErrorを返す。

### ステップ4：実行コンテキスト作成

実行に必要なすべての情報を集約したExecutionContextを作成する。既存の会話からsession_idを取得し、継続実行（resume）を可能にする。ターン番号は過去の実行回数から計算される。

### ステップ5：SDKオプション構築

OptionsBuilderがExecutionContextからSDKオプションを構築する。この過程で以下が行われる。

**システムプロンプトの組み立て**

テナント設定のsystem_promptを基本とし、ワークスペースが有効な場合はワークスペース情報（パス、ファイル一覧、操作指示）を追加する。preferred_skillsが指定されている場合は、それらのスキルを優先使用するよう指示を追加する。

**MCPサーバー設定の構築**

テナントに紐づくアクティブなMCPサーバーをすべて取得し、SDK形式の設定に変換する。headers_templateのトークンプレースホルダ（${token_name}）をリクエストのtokensで置換する。OpenAPIタイプのサーバーはOpenApiMcpServiceで変換処理を行う。

**AWS環境変数の設定**

Bedrock使用フラグ、リージョン、認証情報、モデル設定をSDKに渡す環境変数として構築する。サブエージェント用モデル（CLAUDE_CODE_SUBAGENT_MODEL）も設定する。

### ステップ6：SDK実行

構築したオプションでClaude Agent SDKを初期化し、ユーザー入力をクエリとして送信する。SDKはAWS Bedrockと通信し、非同期にメッセージストリームを返す。

### ステップ7：メッセージ処理

SDKから受信した各メッセージをMessageProcessorが処理する。メッセージタイプに応じて適切なSSEイベントに変換し、クライアントに送信する。同時にメッセージログをExecutionContextに蓄積する。

### ステップ8：ツール追跡

ToolTrackerがすべてのツール実行を追跡する。ツールの開始・完了を記録し、サブエージェント（Taskツール）の場合は使用するモデルや使用量も個別に追跡する。サブエージェントは並列実行されることがあるため、複数のアクティブなサブエージェントを同時に追跡できる設計となっている。

### ステップ9：結果処理

実行完了（resultメッセージ受信）後、以下の後処理を行う。

- session_idの更新：SDKから返されたsession_idを会話に保存し、次回の継続実行を可能にする
- タイトル自動生成：初回実行時、ユーザー入力とAI応答からタイトルを自動生成する（別途Bedrockを使用）
- 使用量ログ保存：メインエージェントとサブエージェントそれぞれの使用量をusage_logsに保存
- メッセージログ保存：蓄積したメッセージログをmessage_logsに一括保存
- ツール実行ログ保存：ツール実行履歴をtool_execution_logsに保存

### ステップ10：ロック解放とトランザクション

会話ロックを解放する。実行が成功した場合はトランザクションをコミットし、失敗した場合はロールバックする。

---

## メッセージタイプ

SDKから受信するメッセージは4種類ある。

### systemメッセージ

SDKセッションの初期化（init）と終了（finish）を通知する。initメッセージにはsession_idが含まれ、これを保存することで会話の継続が可能になる。

### assistantメッセージ

AIからの出力を表す。以下のサブタイプがある。

- **text**：通常のテキスト出力。SSEのtext_deltaイベントに変換される。
- **tool_use**：ツール呼び出しの要求。tool_use_id、tool_name、tool_inputを含む。SSEのtool_useイベントに変換される。
- **thinking**：拡張思考（Extended Thinking）の内容。SSEのthinkingイベントに変換される。

### userメッセージ

ツール実行結果を表す。SDKが内部的にツールを実行し、その結果をuserメッセージとして返す。tool_use_id、content（結果）、is_error（エラーフラグ）を含む。SSEのtool_resultイベントに変換される。

### resultメッセージ

実行完了を表す。result（最終テキスト）、is_error（エラーフラグ）、errors（エラー配列）、usage（使用量）、total_cost_usd（総コスト）、num_turns（ターン数）、duration_ms（実行時間）、session_id（セッションID）を含む。SSEのresultイベントに変換される。

---

## サブエージェント追跡

Taskツールを通じて起動されるサブエージェントは、メインエージェントとは別のモデル（通常はHaiku）で実行される。ToolTrackerはサブエージェントを以下のように追跡する。

### サブエージェント開始

Taskツールのtool_useが発生すると、ToolTrackerはサブエージェントの開始を記録する。入力パラメータからsubagent_type（エージェントタイプ）とmodel（モデルエイリアス）を抽出する。modelエイリアス（haiku、sonnetなど）は環境変数の設定を参照して実際のBedrockモデルIDに解決される。

### 並列実行対応

サブエージェントは並列実行されることがある。ToolTrackerはactiveSubagentsマップで複数のアクティブなサブエージェントを同時に追跡する。各サブエージェントはtool_use_idをキーとして管理される。

### サブエージェント完了

Taskツールのtool_resultが発生すると、ToolTrackerはサブエージェントの完了を記録する。結果からサブエージェントの使用量（トークン数）を抽出し、SubagentUsageInfoに保存する。

### 使用量の分離記録

実行完了後、メインエージェントの使用量とサブエージェントの使用量は別々のusage_logsレコードとして保存される。これにより、モデル別のコスト分析が正確に行える。

---

## セッション継続（Resume）

本システムは会話の継続実行をサポートする。

### session_idの役割

Claude Agent SDKはセッションIDを使用して会話状態を管理する。一度実行された会話のsession_idを保存し、次回実行時にresumeオプションとして渡すことで、前回の会話コンテキストを維持したまま継続できる。

### 継続実行の流れ

1. 初回実行時、SDKはsession_idを生成してresultメッセージで返す
2. システムはsession_idを会話（conversations.session_id）に保存する
3. 次回実行時、会話からsession_idを取得してSDKオプションのresumeに設定する
4. SDKは前回のコンテキストを復元して実行を継続する

### 新規セッションへの切り替え

会話のsession_idをnullにリセットすると、次回実行時は新規セッションとして開始される。これはコンテキストをクリアしたい場合に使用できる。

---

## エラーハンドリング

エージェント実行中に発生しうるエラーとその処理を説明する。

### ConversationLockError

会話が他のリクエストによってロックされている場合に発生。クライアントにはCONVERSATION_LOCKEDエラーを返し、しばらく待ってから再試行するよう促す。

### SDKError

Claude Agent SDKで発生したエラー。クライアントにはSDK_ERRORとしてエラーメッセージを含めて返す。

### タイムアウト

実行が300秒を超えた場合、タイムアウトとして処理を中断する。部分的な結果がある場合はそれを返す。

### 予期しないエラー

その他の例外はINTERNAL_ERRORとしてログに記録し、クライアントには一般的なエラーメッセージを返す。

### エラー時の後処理

エラー発生時も会話ロックは確実に解放される。トランザクションはロールバックされ、部分的な変更は保存されない。

---

## タイトル自動生成

初回実行時、会話のタイトルを自動生成する機能がある。

### 生成タイミング

会話にタイトルが設定されていない状態で実行が成功した場合に、タイトル生成が実行される。

### 生成方法

TitleGeneratorクラスがAWS Bedrockを使用して、ユーザー入力とAI応答からタイトルを生成する。軽量な処理のため、通常はHaikuモデルを使用する。

### 生成内容

会話の主題を簡潔に表現した短いタイトル（通常50文字以内）が生成される。
